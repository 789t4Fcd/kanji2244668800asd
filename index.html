<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>漢字練習 完全版</title>

<style>
body{
  font-family:sans-serif;
  background:#f2f2f2;
  margin:0;
  padding:0;
  text-align:center;
}
select, button{
  font-size:16px;
  padding:5px;
  margin:5px;
}
canvas{
  border:2px solid #000;
  background:#fff;
  touch-action:none;
  display:block;
  margin:10px 0 0 20px; /* 左寄せ */
}
#strokeArea svg{
  width:200px;
  height:200px;
}
.correct{color:green;font-weight:bold;}
.wrong{color:red;font-weight:bold;}
#kanjiDisplay{
  font-size:48px;
  display:inline-block;
  vertical-align:top;
  margin-right:10px;
}
.info-list{
  display:flex;
  flex-direction:column;
  text-align:left;
  margin-right:10px;
}
#mainDisplay{
  display:flex;
  justify-content:flex-start;
  align-items:flex-start;
  margin-top:20px;
}
</style>
</head>
<body>

<h2>漢字練習アプリ</h2>

<div style="text-align:center;">
  <label>学年：<select id="grade"></select></label>
  <label>漢字：<select id="kanji"></select></label>
</div>

<div style="text-align:center;">
  <button onclick="clearCanvas()">消す</button>
  <button onclick="toggleEraser()">消しゴム</button>
  <button onclick="checkAnswer()">判定</button>
</div>

<div id="mainDisplay">
  <div class="info-list">
    <div id="info"></div>
  </div>
  <div id="kanjiDisplay"></div>
  <div id="strokeArea"></div>
</div>

<canvas id="canvas"></canvas>
<div id="result"></div>

<script>
let data;
let canvas=document.getElementById("canvas");
let ctx=canvas.getContext("2d");

let drawing=false;
let eraser=false;
let strokeCount=0;
let correctStrokeCount=0;

let penSize=8;
let eraserSize=25;

// ===== Retina対応 + 縦横比2:1 =====
function resizeCanvas(){
  const ratio=window.devicePixelRatio||1;
  const width=400;
  const height=800; // 縦横比2:1

  canvas.width=width*ratio;
  canvas.height=height*ratio;
  canvas.style.width=width+"px";
  canvas.style.height=height+"px";
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(ratio,ratio);

  drawGrid();
}
resizeCanvas();

// ===== 手書きマス（上下2行・正方形、サイズ2/3に縮小） =====
function drawGrid(){
  const w=canvas.width/(window.devicePixelRatio||1);
  const h=canvas.height/(window.devicePixelRatio||1);
  ctx.clearRect(0,0,w,h);
  ctx.lineWidth=1;
  ctx.strokeStyle="#aaa";

  const boxSize = Math.min(w, h/2) * 2/3; // 2/3に縮小

  for(let row=0; row<2; row++){
    const y = row * boxSize;
    ctx.strokeRect(0, y, boxSize, boxSize);
  }
}

// ===== データ読み込み =====
fetch("kanji-data.json")
.then(res=>res.json())
.then(json=>{
  data=json;
  setupGrades();
});

// ===== 学年 =====
function setupGrades(){
  let g=document.getElementById("grade");
  Object.keys(data).forEach(grade=>{
    let opt=document.createElement("option");
    opt.value=grade;
    opt.textContent=grade+"年生";
    g.appendChild(opt);
  });
  g.onchange=loadKanji;
  loadKanji();
}

// ===== 漢字 =====
function loadKanji(){
  let grade=document.getElementById("grade").value;
  let k=document.getElementById("kanji");
  k.innerHTML="";
  Object.keys(data[grade]).forEach(kan=>{
    let opt=document.createElement("option");
    opt.value=kan;
    opt.textContent=kan;
    k.appendChild(opt);
  });
  k.onchange=showKanji;
  showKanji();
}

// ===== 漢字表示 =====
function showKanji(){
  strokeCount=0;
  clearCanvas();

  let grade=document.getElementById("grade").value;
  let kan=document.getElementById("kanji").value;
  let info=data[grade][kan];

  document.getElementById("info").innerHTML=
    "音："+info.on.join(", ")+"<br>"+
    "訓："+info.kun.join(", ")+"<br>"+
    "熟語："+info.jukugo.join(", ");

  document.getElementById("kanjiDisplay").innerHTML=kan;

  loadSVG(kan);
}

// ===== SVG読み込み（無限ループ・前の画残す・全消し後再スタート） =====
function loadSVG(kanji){
  let code=kanji.charCodeAt(0).toString(16).padStart(4,"0");

  fetch("kanji-svg/"+code+".svg")
  .then(res=>{
    if(!res.ok) throw new Error("SVGが見つかりません");
    return res.text();
  })
  .then(svg=>{
    svg = svg.trim(); // 不要文字削除
    document.getElementById("strokeArea").innerHTML=svg;
    const paths = document.querySelectorAll("#strokeArea svg path");
    correctStrokeCount = paths.length;

    let current = 0;

    function animate(){
      function showStroke(){
        if(paths.length===0) return;

        paths[current].style.transition="stroke-dashoffset 0.5s";
        paths[current].style.strokeDashoffset=0;

        current++;
        if(current >= paths.length){
          setTimeout(()=>{
            paths.forEach(p=>{
              p.style.transition="";
              p.style.strokeDasharray=1000;
              p.style.strokeDashoffset=1000;
            });
            current = 0;
            setTimeout(showStroke, 500);
          }, 1000);
        } else {
          setTimeout(showStroke, 600);
        }
      }
      showStroke();
    }

    paths.forEach(p=>{
      p.style.strokeDasharray=1000;
      p.style.strokeDashoffset=1000;
    });
    animate();

  })
  .catch(()=>{
    document.getElementById("strokeArea").innerHTML=
      "<div style='color:red'>書き順SVGが見つかりません</div>";
    correctStrokeCount=0;
  });
}

// ===== 描画処理 =====
canvas.addEventListener("pointerdown",(e)=>{
  drawing=true;
  strokeCount++;
  const rect=canvas.getBoundingClientRect();
  const x=e.clientX-rect.left;
  const y=e.clientY-rect.top;
  ctx.beginPath();
  ctx.moveTo(x,y);
});

canvas.addEventListener("pointermove",(e)=>{
  if(!drawing) return;
  const rect=canvas.getBoundingClientRect();
  const x=e.clientX-rect.left;
  const y=e.clientY-rect.top;
  if(eraser){
    ctx.clearRect(x-eraserSize/2,y-eraserSize/2,eraserSize,eraserSize);
  }else{
    ctx.lineWidth=penSize;
    ctx.lineCap="round";
    ctx.strokeStyle="black";
    ctx.lineTo(x,y);
    ctx.stroke();
  }
});

canvas.addEventListener("pointerup",()=>{drawing=false;ctx.beginPath();});
canvas.addEventListener("pointerleave",()=>{drawing=false;ctx.beginPath();});

// ===== ボタン =====
function clearCanvas(){drawGrid(); ctx.beginPath(); strokeCount=0;}
function toggleEraser(){eraser=!eraser;}
function checkAnswer(){
  let result=document.getElementById("result");
  let kan=document.getElementById("kanji").value;

  if(correctStrokeCount===0){
    result.innerHTML="<span class='wrong'>SVG未設定</span>";
    return;
  }

  if(strokeCount===correctStrokeCount){
    result.innerHTML="<span class='correct'>正解！</span>";
    localStorage.setItem(kan,"OK");
  }else{
    result.innerHTML="<span class='wrong'>画数："+strokeCount+" / 正："+correctStrokeCount+"</span>";
    localStorage.setItem(kan,"NG");
  }
}
</script>

</body>
</html>
