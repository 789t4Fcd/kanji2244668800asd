<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>漢字練習 完全版</title>

<link rel="manifest" href="manifest.json">

<style>
body{
  font-family:sans-serif;
  background:#f2f2f2;
  margin:0;
  padding:0;
  text-align:center;
}
select, button{
  font-size:18px;
  padding:5px;
  margin:5px;
}
canvas{
  border:2px solid #000;
  background:#fff;
  touch-action:none;
  display:block;
  margin:10px auto;
}
#strokeArea svg{
  width:200px;
  height:200px;
}
.correct{color:green;font-weight:bold;}
.wrong{color:red;font-weight:bold;}
#kanjiDisplay{
  font-size:72px;
  display:inline-block;
  vertical-align:top;
  margin-right:10px;
}
.info-list{
  display:flex;
  flex-direction:column;
  text-align:left;
  margin-right:10px;
}
#mainDisplay{
  display:flex;
  justify-content:center;
  align-items:flex-start;
  margin-top:20px;
}
</style>
</head>
<body>

<h2>漢字練習アプリ</h2>

<!-- 学年・漢字 横並び -->
<div style="text-align:center;">
  <label>学年：<select id="grade"></select></label>
  <label>漢字：<select id="kanji"></select></label>
</div>

<!-- ボタン -->
<div style="text-align:center;">
  <button onclick="clearCanvas()">消す</button>
  <button onclick="toggleEraser()">消しゴム</button>
  <button onclick="checkAnswer()">判定</button>
</div>

<!-- メイン表示エリア -->
<div id="mainDisplay">
  <!-- 音・訓・熟語 -->
  <div class="info-list">
    <div id="info"></div>
  </div>

  <!-- 完成漢字 -->
  <div id="kanjiDisplay"></div>

  <!-- 書き順SVG -->
  <div id="strokeArea"></div>
</div>

<canvas id="canvas"></canvas>
<div id="result"></div>

<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js');
}

let data;
let canvas=document.getElementById("canvas");
let ctx=canvas.getContext("2d");

let drawing=false;
let eraser=false;
let strokeCount=0;
let correctStrokeCount=0;

let penSize=8;
let eraserSize=25;

// ===== Retina対応 =====
function resizeCanvas(){
  const ratio=window.devicePixelRatio||1;
  const width=800;
  const height=400;
  canvas.width=width*ratio;
  canvas.height=height*ratio;
  canvas.style.width=width+"px";
  canvas.style.height=height+"px";
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(ratio,ratio);

  drawGrid();
}
resizeCanvas();

// ===== 左右2マス、各マス4分割の点線 =====
function drawGrid(){
  const w=canvas.width/(window.devicePixelRatio||1);
  const h=canvas.height/(window.devicePixelRatio||1);
  ctx.clearRect(0,0,w,h);
  ctx.lineWidth=1;
  ctx.strokeStyle="#aaa";

  const boxWidth=w/2;
  const boxHeight=h;

  for(let col=0;col<2;col++){
    // 外枠
    ctx.beginPath();
    ctx.strokeStyle="#aaa";
    ctx.strokeRect(col*boxWidth,0,boxWidth,boxHeight);

    // 中線（縦横4分割）
    ctx.setLineDash([5,5]);
    ctx.beginPath();
    ctx.moveTo(col*boxWidth+boxWidth/2,0);
    ctx.lineTo(col*boxWidth+boxWidth/2,boxHeight);
    ctx.moveTo(col*boxWidth,boxHeight/2);
    ctx.lineTo((col+1)*boxWidth,boxHeight/2);
    ctx.stroke();
    ctx.setLineDash([]);
  }
}

// ===== データ読み込み =====
fetch("kanji-data.json")
.then(res=>res.json())
.then(json=>{
  data=json;
  setupGrades();
});

// ===== 学年 =====
function setupGrades(){
  let g=document.getElementById("grade");
  Object.keys(data).forEach(grade=>{
    let opt=document.createElement("option");
    opt.value=grade;
    opt.textContent=grade+"年生";
    g.appendChild(opt);
  });
  g.onchange=loadKanji;
  loadKanji();
}

// ===== 漢字 =====
function loadKanji(){
  let grade=document.getElementById("grade").value;
  let k=document.getElementById("kanji");
  k.innerHTML="";
  Object.keys(data[grade]).forEach(kan=>{
    let opt=document.createElement("option");
    opt.value=kan;
    opt.textContent=kan;
    k.appendChild(opt);
  });
  k.onchange=showKanji;
  showKanji();
}

// ===== 漢字表示 =====
function showKanji(){
  strokeCount=0;
  clearCanvas();

  let grade=document.getElementById("grade").value;
  let kan=document.getElementById("kanji").value;
  let info=data[grade][kan];

  document.getElementById("info").innerHTML=
    "音："+info.on.join(", ")+"<br>"+
    "訓："+info.kun.join(", ")+"<br>"+
    "熟語："+info.jukugo.join(", ");

  document.getElementById("kanjiDisplay").innerHTML=kan;

  loadSVG(kan);
}

// ===== SVG読み込み（無限ループ） =====
function loadSVG(kanji){
  let code=kanji.charCodeAt(0).toString(16).padStart(4,"0");

  fetch("kanji-svg/"+code+".svg")
  .then(res=>{
    if(!res.ok) throw new Error("SVGが見つかりません");
    return res.text();
  })
  .then(svg=>{
    document.getElementById("strokeArea").innerHTML=svg;
    let paths=document.querySelectorAll("#strokeArea svg path");
    correctStrokeCount=paths.length;

    let i=0;
    function animate(){
      paths.forEach(p=>{
        p.style.transition="";
        p.style.strokeDasharray=1000;
        p.style.strokeDashoffset=1000;
      });
      function showStroke(){
        if(paths.length===0) return;
        paths.forEach((p,j)=>{
          if(j!==i)p.style.strokeDashoffset=1000;
        });
        let p=paths[i];
        p.style.transition="stroke-dashoffset 0.5s";
        p.style.strokeDashoffset=0;
        i=(i+1)%paths.length;
        setTimeout(showStroke,600);
      }
      showStroke();
    }
    animate();
  })
  .catch(()=>{
    document.getElementById("strokeArea").innerHTML=
      "<div style='color:red'>書き順SVGが見つかりません</div>";
    correctStrokeCount=0;
  });
}

// ===== 描画処理 =====
canvas.addEventListener("pointerdown",(e)=>{
  drawing=true;
  strokeCount++;
  const rect=canvas.getBoundingClientRect();
  const x=e.clientX-rect.left;
  const y=e.clientY-rect.top;
  ctx.beginPath();
  ctx.moveTo(x,y);
});

canvas.addEventListener("pointermove",(e)=>{
  if(!drawing) return;
  const rect=canvas.getBoundingClientRect();
  const x=e.clientX-rect.left;
  const y=e.clientY-rect.top;
  if(eraser){
    ctx.clearRect(x-eraserSize/2,y-eraserSize/2,eraserSize,eraserSize);
  }else{
    ctx.lineWidth=penSize;
    ctx.lineCap="round";
    ctx.strokeStyle="black";
    ctx.lineTo(x,y);
    ctx.stroke();
  }
});

canvas.addEventListener("pointerup",()=>{drawing=false;ctx.beginPath();});
canvas.addEventListener("pointerleave",()=>{drawing=false;ctx.beginPath();});

// ===== ボタン =====
function clearCanvas(){drawGrid(); ctx.beginPath(); strokeCount=0;}
function toggleEraser(){eraser=!eraser;}
function checkAnswer(){
  let result=document.getElementById("result");
  let kan=document.getElementById("kanji").value;

  if(correctStrokeCount===0){
    result.innerHTML="<span class='wrong'>SVG未設定</span>";
    return;
  }

  if(strokeCount===correctStrokeCount){
    result.innerHTML="<span class='correct'>正解！</span>";
    localStorage.setItem(kan,"OK");
  }else{
    result.innerHTML="<span class='wrong'>画数："+strokeCount+" / 正："+correctStrokeCount+"</span>";
    localStorage.setItem(kan,"NG");
  }
}
</script>

</body>
</html>
